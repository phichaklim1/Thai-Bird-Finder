<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thai Bird Finder</title>
  <meta name="description" content="ค้นหาและกรองข้อมูลนกในประเทศไทยจากไฟล์ Bird database.xlsx หรือ birds.json" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#0b1220; --panel:#121a2a; --muted:#8ea0c2; --text:#e6eefc; --accent:#3bb2f6; --accent2:#1dd1a1; --chip:#1b2740; --border:#24314d; }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b1220,rgba(11,18,32,.85) 70%,rgba(11,18,32,0));backdrop-filter:saturate(120%) blur(6px);padding:14px 20px;border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:12px} .logo{width:34px;height:34px;border-radius:12px;background:radial-gradient(60% 80% at 30% 30%,#3bb2f6,#1dd1a1 60%,#24314d)} .title{font-weight:700;font-size:20px}
    .subtitle{color:var(--muted);font-size:12px}
    #status{margin-left:8px;color:#bfe7ff;font-size:12px;border:1px solid #1e3858;padding:4px 8px;border-radius:8px;background:#0f1a2c}
    .container{padding:16px 20px 24px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:1000px){.container{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(11,18,32,.35)}
    .filters{padding:14px;display:grid;gap:10px} label{font-size:12px;color:var(--muted)}
    input[type=text],input[type=number],select{width:100%;background:#0e1525;color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;outline:none}
    input:focus,select:focus{border-color:var(--accent)} input::placeholder{color:#6f84ad}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{padding:10px 14px;border:1px solid var(--border);background:#0f1a2c;color:var(--text);border-radius:10px;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,#3bb2f6,#1dd1a1);color:#06233a;border:none}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}.chip{background:#1b2740;border:1px solid var(--border);padding:6px 8px;border-radius:999px;font-size:12px;color:#b8caec}
    .main{display:grid;gap:12px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
    .table-wrap{overflow:auto;border-top:1px solid var(--border)} table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;z-index:5;background:#0e1525;color:#cde2ff;font-size:12px;text-align:left;padding:10px;border-bottom:1px solid var(--border)}
    tbody td{padding:9px 10px;border-bottom:1px solid #19233b;vertical-align:top} tbody tr:nth-child(odd){background:#0b162a}
    .view-toggle .btn.tab{background:#0f1a2c;border-color:var(--border)} .view-toggle .btn.tab.active{background:linear-gradient(90deg,#3bb2f6,#1dd1a1);color:#06233a;border:none}
    .list-wrap{display:none}.list{list-style:none;margin:0;padding:0}.list li{padding:10px;border-bottom:1px solid #19233b}.list li:nth-child(odd){background:#0b162a}
    .list .nm{font-weight:700}.list .en{color:var(--muted)} .list .sci{font-style:italic;color:#b8caec}
    .legend .blue{color:#4a86ff}.legend .orange{color:#d7822f}.legend p{margin:6px 0 10px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">Thai Bird Finder</div>
        <div class="subtitle">ใช้ไฟล์ <code>Bird database.xlsx</code> หรือ <code>birds.json</code> <span id="status">กำลังเริ่มต้น…</span></div>
      </div>
    </div>
  </header>

  <div class="container">
    <aside class="panel">
      <div class="filters">
        <h3>ค้นหา</h3>
        <div class="row">
          <div><label>Thai name (ค้นหาบางส่วนได้)</label><input id="thai" type="text" placeholder="เช่น กระจอก, นกกินปลี ฯลฯ" /></div>
          <div><label>Common name</label><input id="common" type="text" placeholder="e.g. babbler, bulbul" /></div>
        </div>
        <div class="row">
          <div><label>Scientific name</label><input id="scientific" type="text" placeholder="e.g. Pycnonotus" /></div>
          <div><label>Family</label><input id="family" type="text" placeholder="e.g. Anatidae" /></div>
        </div>
        <div><label>Order</label><input id="order" type="text" placeholder="e.g. Passeriformes" /></div>
        <div class="row">
          <div><label>Category</label><select id="category"><option value="">ทั้งหมด</option></select></div>
          <div><label>Seasonal status</label><select id="seasonal"><option value="">ทั้งหมด</option></select></div>
        </div>
        <div class="row">
          <div><label>Global Threat Status</label><select id="gts"><option value="">ทั้งหมด</option></select></div>
          <div><label>National Threat Status</label><select id="nts"><option value="">ทั้งหมด</option></select></div>
        </div>
        <div><label>National Threat Level (BCST)</label><select id="ntl"><option value="">ทั้งหมด</option></select></div>
        <div class="row">
          <div><label>L&amp;R (min)</label><input id="lrMin" type="number" inputmode="numeric" /></div>
          <div><label>L&amp;R (max)</label><input id="lrMax" type="number" inputmode="numeric" /></div>
        </div>
        <div class="btns">
          <button class="btn primary" id="btnSearch">ค้นหา</button>
          <button class="btn" id="btnReset">ล้างค่า</button>
          <button class="btn" id="btnExport">ดาวน์โหลดผลลัพธ์ (CSV)</button>
        </div>
        <div class="chips" id="activeFilters"></div>
      </div>
    </aside>

    <main class="panel main">
      <div class="toolbar">
        <div class="count"><span id="rowCount">–</span> ผลลัพธ์</div>
        <div class="btns view-toggle">
          <button class="btn tab active" id="btnTable">แสดงตาราง</button>
          <button class="btn tab" id="btnList">แสดงลิสต์</button>
          <button class="btn" id="btnCopyList" style="display:none;">คัดลอกลิสต์</button>
        </div>
        <div class="small">ข้อมูลต้นฉบับ: <code>Bird database.xlsx</code> • รองรับ <code>birds.json</code></div>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead><tr>
            <th style="min-width:60px;">No.</th>
            <th style="min-width:70px;">L&amp;R</th>
            <th style="min-width:200px;">Thai name</th>
            <th style="min-width:220px;">Common name</th>
            <th style="min-width:220px;">Scientific name</th>
            <th style="min-width:160px;">Family</th>
            <th style="min-width:160px;">Order</th>
            <th style="min-width:90px;">Category</th>
            <th style="min-width:150px;">Seasonal status</th>
            <th style="min-width:200px;">Global Threat Status</th>
            <th style="min-width:230px;">National Threat Status</th>
            <th style="min-width:200px;">National Threat Level (BCST)</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="list-wrap" id="listWrap" style="display:none;"></div>
      <div class="foot-note" style="padding:12px 14px;color:#8ea0c2;font-size:12px;border-top:1px dashed var(--border)">
        เคล็ดลับ: พิมพ์บางส่วนของชื่อแล้วกด Enter หรือปุ่ม “ค้นหา” • หากผลลัพธ์ยังเป็น “–” ให้รีเฟรชแบบล้างแคช (Cmd+Shift+R)
      </div>
    </main>
  </div>

  <!-- Legend block -->
  <div class="container">
    <aside class="panel" style="grid-column:1 / -1;">
      <div class="filters">
        <h3>Abbreviation legend (EN)</h3>
        <div class="legend">
          <p><span class="blue"><strong>Category:</strong></span><br>
            <b>A</b> recorded in an apparently wild state within the last 50 years;<br>
            <b>B</b> not recorded in wild in last 50 years;<br>
            <b>C</b> introduced, with feral breeding stock apparently self-supporting;<br>
            <b>D</b> seen in apparently wild state but possibility of escape or release from captivity not excluded;<br>
            <b>E</b> previously published records questionable owing to possibility of mistaken identification;<br>
            <b>F</b> occurrence of apparent hybrid individuals without proof of genuine pure individuals
          </p>
          <p><span class="blue"><strong>Seasonal status:</strong></span><br>
            <b>R</b> resident or presumed resident; <b>N</b> non-breeding visitor; <b>B</b> breeding visitor;
            <b>P</b> mainly spring and autumn passage migrant; <b>V</b> vagrant (non-breeding visitor with three or fewer records)
          </p>
          <p><span class="orange"><strong>Global/National threat status:</strong></span><br>
            <b>EX</b> Extinct; <b>EW</b> Extinct in the wild; <b>CR</b> critically endangered; <b>EN</b> endangered;
            <b>VU</b> vulnerable; <b>NT</b> near-threatened; <b>DD</b> data-deficient; <b>LC</b> or blank = Least Concern (National Threat Status is based on ONEP)
          </p>
        </div>
      </div>
    </aside>
  </div>

  <script>
  // ===== Helpers & State =====
  const S = id => document.getElementById(id);
  const H = {
    inc: (a,b)=> String(a||'').toLowerCase().includes(String(b||'').trim().toLowerCase()),
    uniq: (arr)=> Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> String(a).localeCompare(String(b))),
    num: v => (v===''||v==null) ? null : Number(v),
    csv: v => {const s = v==null?'':String(v); return (s.includes(',')||s.includes('\"')||s.includes('\\n')) ? '\"'+s.replaceAll('\"','\"\"')+'\"' : s;},
    status: msg => { S('status').textContent = msg; console.log('[status]', msg); }
  };
  const COL = {
    no:'No.', lr:'L&R', thai:'Thai name', common:'Common name', sci:'Scientific name', family:'Family', order:'Order',
    cat:'Category', seas:'Seasonal status', gts:'Global Threat Status (BirdLife 2021)', nts:'National Threat Status (ONEP 2020)', ntl:'National Threat Level (BCST)'
  };
  let ALL = [], FILTERED = [], LOADED = false;

  // ===== Data Loading (with cache-busting & clear status) =====
  async function loadJSON(){
    try{
      const res = await fetch('birds.json?v='+Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error('JSON format not array');
      H.status('โหลดจาก birds.json: '+data.length+' แถว');
      return data;
    }catch(e){ H.status('โหลด JSON ไม่สำเร็จ ('+e.message+')'); return null; }
  }
  async function loadXLSX(path='Bird database.xlsx'){
    try{
      const res = await fetch(path+'?v='+Date.now());
      if(!res.ok) throw new Error('HTTP '+res.status);
      const ab = await res.arrayBuffer();
      const wb = XLSX.read(ab,{type:'array'});
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:''});
      H.status('โหลดจาก Excel: '+rows.length+' แถว');
      return rows;
    }catch(e){ H.status('โหลด Excel ไม่สำเร็จ ('+e.message+')'); return null; }
  }
  function normalize(rows){
    return rows.map(r => ({
      [COL.no]: r[COL.no] ?? r['No'] ?? r['no'] ?? '',
      [COL.lr]: r[COL.lr] ?? r['L&R Number'] ?? r['L&R number'] ?? r['L&R No'] ?? '',
      [COL.thai]: r[COL.thai] ?? r['Thai'] ?? r['Thai Name'] ?? '',
      [COL.common]: r[COL.common] ?? r['English name'] ?? r['Common Name'] ?? '',
      [COL.sci]: r[COL.sci] ?? r['Scientific Name'] ?? '',
      [COL.family]: r[COL.family] ?? '',
      [COL.order]: r[COL.order] ?? '',
      [COL.cat]: r[COL.cat] ?? '',
      [COL.seas]: r[COL.seas] ?? '',
      [COL.gts]: r[COL.gts] ?? r['Global Threat Status'] ?? '',
      [COL.nts]: r[COL.nts] ?? r['National Threat Status'] ?? '',
      [COL.ntl]: r[COL.ntl] ?? r['National Threat Level'] ?? '',
    }));
  }

  async function ensureLoaded(){
    if(LOADED && ALL.length) return true;
    H.status('กำลังโหลดข้อมูล…');
    let raw = await loadJSON();
    if(!raw) raw = await loadXLSX('Bird database.xlsx');
    if(!raw){ H.status('ไม่พบข้อมูล — โปรดอัปโหลด birds.json หรือ Bird database.xlsx'); return false; }
    ALL = normalize(raw); LOADED = true;
    // populate selects and render once
    populateSelect('category', ALL.map(r=>r[COL.cat]));
    populateSelect('seasonal', ALL.map(r=>r[COL.seas]));
    populateSelect('gts', ALL.map(r=>r[COL.gts]));
    populateSelect('nts', ALL.map(r=>r[COL.nts]));
    populateSelect('ntl', ALL.map(r=>r[COL.ntl]));
    render(ALL);
    H.status('พร้อมใช้งาน ('+ALL.length+' แถว)');
    return true;
  }

  // ===== UI render =====
  function render(rows){
    const tb = S('tbody'); const safe = v => (v==null||v==='')?'':String(v);
    tb.innerHTML = rows.map(r => `<tr>
      <td>${safe(r[COL.no])}</td><td>${safe(r[COL.lr])}</td>
      <td>${safe(r[COL.thai])}</td><td>${safe(r[COL.common])}</td>
      <td><i>${safe(r[COL.sci])}</i></td><td>${safe(r[COL.family])}</td>
      <td>${safe(r[COL.order])}</td><td>${safe(r[COL.cat])}</td>
      <td>${safe(r[COL.seas])}</td><td>${safe(r[COL.gts])}</td>
      <td>${safe(r[COL.nts])}</td><td>${safe(r[COL.ntl])}</td>
    </tr>`).join('');
    S('rowCount').textContent = rows.length.toLocaleString();
    // list view
    const wrap = S('listWrap');
    wrap.innerHTML = '<ul class="list">'+ rows.map(r => `<li><span class="nm">${safe(r[COL.thai])}</span><br><span class="en">${safe(r[COL.common])}</span> • <span class="sci"><i>${safe(r[COL.sci])}</i></span></li>`).join('') + '</ul>';
  }
  function populateSelect(id, vals){
    const el = S(id);
    el.innerHTML = '<option value="">ทั้งหมด</option>' + H.uniq(vals).map(v=> `<option>${String(v)}</option>`).join('');
  }
  function getFilters(){
    return {
      thai:S('thai').value, common:S('common').value, sci:S('scientific').value, family:S('family').value, order:S('order').value,
      cat:S('category').value, seas:S('seasonal').value, gts:S('gts').value, nts:S('nts').value, ntl:S('ntl').value,
      lrMin:H.num(S('lrMin').value), lrMax:H.num(S('lrMax').value)
    };
  }
  function showChips(f){
    const chips=[]; const add=(k,v)=>{ if(v!=='' && v!=null) chips.push(`<span class="chip">${k}: ${v}</span>`); };
    add('Thai',f.thai); add('Common',f.common); add('Scientific',f.sci); add('Family',f.family); add('Order',f.order);
    add('Category',f.cat); add('Seasonal',f.seas); add('Global',f.gts); add('National',f.nts); add('BCST',f.ntl);
    if(f.lrMin!=null) add('L&R ≥',f.lrMin); if(f.lrMax!=null) add('L&R ≤',f.lrMax);
    S('activeFilters').innerHTML = chips.join('');
  }
  function filterAndRender(){
    const f = getFilters(); showChips(f);
    FILTERED = ALL.filter(r => {
      if(f.thai && !H.inc(r[COL.thai], f.thai)) return false;
      if(f.common && !H.inc(r[COL.common], f.common)) return false;
      if(f.sci && !H.inc(r[COL.sci], f.sci)) return false;
      if(f.family && !H.inc(r[COL.family], f.family)) return false;
      if(f.order && !H.inc(r[COL.order], f.order)) return false;
      if(f.cat && String(r[COL.cat]) !== String(f.cat)) return false;
      if(f.seas && String(r[COL.seas]) !== String(f.seas)) return false;
      if(f.gts && String(r[COL.gts]) !== String(f.gts)) return false;
      if(f.nts && String(r[COL.nts]) !== String(f.nts)) return false;
      if(f.ntl && String(r[COL.ntl]) !== String(f.ntl)) return false;
      const n = Number(r[COL.lr]); if(f.lrMin!=null && !(n>=f.lrMin)) return false; if(f.lrMax!=null && !(n<=f.lrMax)) return false;
      return true;
    });
    render(FILTERED);
  }

  // ===== View controls =====
  function setView(v){
    const tbl = document.querySelector('.table-wrap'), list = S('listWrap');
    tbl.style.display = (v==='table')?'block':'none'; list.style.display = (v==='list')?'block':'none';
    document.getElementById('btnTable').classList.toggle('active', v==='table');
    document.getElementById('btnList').classList.toggle('active', v==='list');
    document.getElementById('btnCopyList').style.display = (v==='list')?'inline-block':'none';
  }
  function copyList(){
    const rows = FILTERED.length?FILTERED:ALL;
    const text = rows.map(r => `${r[COL.thai]} — ${r[COL.common]} — ${r[COL.sci]}`).join('\\n');
    navigator.clipboard.writeText(text).then(()=>alert('คัดลอกลิสต์แล้ว — '+rows.length+' รายการ'));
  }

  // ===== Boot =====
  async function init(){
    // bind UI first
    document.getElementById('btnSearch').addEventListener('click', async ()=>{ const ok = await ensureLoaded(); if(ok) filterAndRender(); });
    document.getElementById('btnReset').addEventListener('click', ()=>{ for(const id of ['thai','common','scientific','family','order','category','seasonal','gts','nts','ntl','lrMin','lrMax']) S(id).value=''; if(ALL.length) filterAndRender(); });
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const rows = FILTERED.length?FILTERED:ALL;
      const headers=[COL.no,COL.lr,COL.thai,COL.common,COL.sci,COL.family,COL.order,COL.cat,COL.seas,COL.gts,COL.nts,COL.ntl];
      const csv=[headers.join(',')].concat(rows.map(r=>headers.map(h=>H.csv(r[h])).join(','))).join('\\n');
      const url = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'})); const a=document.createElement('a'); a.href=url; a.download='thai-bird-finder.csv'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('btnTable').addEventListener('click', ()=>setView('table'));
    document.getElementById('btnList').addEventListener('click', ()=>setView('list'));
    document.getElementById('btnCopyList').addEventListener('click', copyList);
    for(const id of ['thai','common','scientific','family','order']) S(id).addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('btnSearch').click(); });
    for(const id of ['category','seasonal','gts','nts','ntl','lrMin','lrMax']) S(id).addEventListener('change', ()=>{ if(ALL.length) filterAndRender(); });

    // pre-load data once soผู้ใช้เห็นตัวเลขทันที
    const ok = await ensureLoaded();
    if(!ok){ /* keep UI usable; user can upload files later */ }
  }
  init();
  </script>
</body>
</html>
