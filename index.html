<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thai Bird Finder by Phichak Limprasutr</title>
  <meta name="description" content="ค้นหาข้อมูลนกในประเทศไทย" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#0b1220; --panel:#121a2a; --muted:#8ea0c2; --text:#e6eefc; --accent:#3bb2f6; --accent2:#1dd1a1; --chip:#1b2740; --border:#24314d; }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b1220 0%,rgba(11,18,32,.85) 70%,rgba(11,18,32,0));backdrop-filter:saturate(120%) blur(6px);padding:18px 20px 8px;border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:12px} .logo{width:36px;height:36px;border-radius:12px;background:radial-gradient(60% 80% at 30% 30%,#3bb2f6,#1dd1a1 60%,#24314d)} .title{font-weight:700;font-size:20px} .subtitle{color:var(--muted);font-size:12px}
    .container{padding:16px 20px 24px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:1000px){.container{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(11,18,32,.35)}
    .panel h3{margin:0 0 12px;font-size:14px;font-weight:700;color:#cfe2ff} .panel .p{color:var(--muted);font-size:13px}
    .sidebar{position:sticky;top:76px;align-self:start} .filters{padding:14px;display:grid;gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 4px}
    input[type=text],input[type=number],select{width:100%;background:#0e1525;color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;outline:none}
    input:focus,select:focus{border-color:var(--accent)} input::placeholder{color:#6f84ad}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:10px 14px;border:1px solid var(--border);background:#0f1a2c;color:var(--text);border-radius:10px;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,#3bb2f6,#1dd1a1);color:#06233a;border:none}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px} .chip{background:#1b2740;border:1px solid var(--border);padding:6px 8px;border-radius:999px;font-size:12px;color:#b8caec}
    .main{padding:0;display:grid;gap:12px} .toolbar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
    .count{color:var(--muted);font-size:13px}
    .table-wrap{overflow:auto;border-top:1px solid var(--border)} table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;z-index:5;background:#0e1525;color:#cde2ff;font-size:12px;text-align:left;padding:10px;border-bottom:1px solid var(--border)}
    tbody td{padding:9px 10px;border-bottom:1px solid #19233b;vertical-align:top} tbody tr:nth-child(odd){background:#0b162a}
    .small{font-size:12px;color:var(--muted)} .foot-note{padding:12px 14px;color:var(--muted);font-size:12px;border-top:1px dashed var(--border)}
    .view-toggle .btn.tab{background:#0f1a2c;border-color:var(--border)} .view-toggle .btn.tab.active{background:linear-gradient(90deg,#3bb2f6,#1dd1a1);color:#06233a;border:none}
    .list-wrap{display:none} .list{list-style:none;margin:0;padding:0} .list li{padding:10px;border-bottom:1px solid #19233b} .list li:nth-child(odd){background:#0b162a}
    .list .nm{font-weight:700} .list .en{color:var(--muted)} .list .sci{font-style:italic;color:#b8caec}
    #status{margin-left:8px;color:#bfe7ff;font-size:12px;border:1px solid #1e3858;padding:4px 8px;border-radius:8px;background:#0f1a2c}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">Thai Bird Finder</div>
        <div class="subtitle">ค้นหาและกรองข้อมูลนกในประเทศไทย • ใช้ไฟล์ Excel <code>Bird database.xlsx</code> หรือ <code>birds.json</code> <span id="status"></span></div>
      </div>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="panel">
        <div class="filters">
          <h3>ค้นหา</h3>
          <div class="row">
            <div><label for="thai">ชื่อไทย (ค้นหาบางส่วนได้)</label><input id="thai" type="text" placeholder="เช่น กระจอก, นกกินปลี ฯลฯ" /></div>
            <div><label for="common">Common name</label><input id="common" type="text" placeholder="e.g. babbler, bulbul" /></div>
          </div>
          <div class="row">
            <div><label for="scientific">Scientific name</label><input id="scientific" type="text" placeholder="e.g. Pycnonotus" /></div>
            <div><label for="family">Family</label><input id="family" type="text" placeholder="e.g. Anatidae" /></div>
          </div>
          <div><label for="order">Order</label><input id="order" type="text" placeholder="e.g. Passeriformes" /></div>
          <div class="row">
            <div><label for="category">Category</label><select id="category"><option value="">ทั้งหมด</option></select></div>
            <div><label for="seasonal">Seasonal status</label><select id="seasonal"><option value="">ทั้งหมด</option></select></div>
          </div>
          <div class="row">
            <div><label for="gts">Global Threat Status</label><select id="gts"><option value="">ทั้งหมด</option></select></div>
            <div><label for="nts">National Threat Status</label><select id="nts"><option value="">ทั้งหมด</option></select></div>
          </div>
          <div><label for="ntl">National Threat Level (BCST)</label><select id="ntl"><option value="">ทั้งหมด</option></select></div>
          <div class="row">
            <div><label for="lrMin">L&amp;R (min)</label><input id="lrMin" type="number" inputmode="numeric" /></div>
            <div><label for="lrMax">L&amp;R (max)</label><input id="lrMax" type="number" inputmode="numeric" /></div>
          </div>
          <div class="btns">
            <button class="btn primary" id="btnSearch">ค้นหา</button>
            <button class="btn" id="btnReset">ล้างค่า</button>
            <button class="btn" id="btnExport">ดาวน์โหลดผลลัพธ์ (CSV)</button>
          </div>
          <div class="chips" id="activeFilters"></div>
        </div>
      </div>
    </aside>

    <main class="panel main">
      <div class="toolbar">
        <div class="count"><span id="rowCount">–</span> ผลลัพธ์</div>
        <div class="btns view-toggle">
          <button class="btn tab active" id="btnTable">แสดงตาราง</button>
          <button class="btn tab" id="btnList">แสดงลิสต์</button>
          <button class="btn" id="btnCopyList" style="display:none;">คัดลอกลิสต์</button>
        </div>
        <div class="small">ข้อมูลต้นฉบับ: <code>Bird database.xlsx</code> • รองรับไฟล์ <code>birds.json</code> เพื่อโหลดเร็วขึ้น</div>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead><tr>
            <th style="min-width:60px;">No.</th>
            <th style="min-width:70px;">L&amp;R</th>
            <th style="min-width:200px;">Thai name</th>
            <th style="min-width:220px;">Common name</th>
            <th style="min-width:220px;">Scientific name</th>
            <th style="min-width:160px;">Family</th>
            <th style="min-width:160px;">Order</th>
            <th style="min-width:90px;">Category</th>
            <th style="min-width:150px;">Seasonal status</th>
            <th style="min-width:200px;">Global Threat Status</th>
            <th style="min-width:230px;">National Threat Status</th>
            <th style="min-width:200px;">National Threat Level (BCST)</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="list-wrap" id="listWrap" style="display:none;"></div>
      <div class="foot-note">เคล็ดลับ: พิมพ์บางส่วนของชื่อแล้วกด “ค้นหา” หรือ Enter</div>
    </main>
  </div>

  <script>
  const H = {
    byId: (id) => document.getElementById(id),
    escapeCSV: (v) => { const s = v == null ? '' : String(v); return (s.includes('"')||s.includes(',')||s.includes('\n')) ? '"' + s.replaceAll('"','""') + '"' : s },
    includesCI: (hay, needle) => String(hay || '').toLowerCase().includes(String(needle || '').trim().toLowerCase()),
    uniqSorted: (arr) => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b))),
    parseNum: (v) => (v === '' || v == null) ? null : Number(v),
    setStatus: (t) => { const el = H.byId('status'); if (el) el.textContent = ' • ' + t; console.log('[status]', t) }
  }

  const COLS = {
    no:'No.', lr:'L&R', thai:'Thai name', common:'Common name', sci:'Scientific name',
    family:'Family', order:'Order', cat:'Category', seas:'Seasonal status',
    gts:'Global Threat Status (BirdLife 2021)', nts:'National Threat Status (ONEP 2020)', ntl:'National Threat Level (BCST)'
  }

  let ALL_ROWS = [], FILTERED = []

  async function tryLoadJSON() {
    try {
      const res = await fetch('birds.json?v=' + Date.now(), { cache: 'no-store' })
      if (!res.ok) throw new Error('JSON HTTP ' + res.status)
      const data = await res.json()
      if (!Array.isArray(data)) throw new Error('JSON format not array')
      H.setStatus('โหลดจาก birds.json: ' + data.length + ' แถว')
      return data
    } catch (e) { H.setStatus('โหลด JSON ไม่สำเร็จ (' + e.message + ')'); return null }
  }

  async function loadXLSX(path='Bird database.xlsx') {
    try {
      const res = await fetch(path + '?v=' + Date.now())
      if (!res.ok) throw new Error('XLSX HTTP ' + res.status)
      const ab = await res.arrayBuffer()
      const wb = XLSX.read(ab, { type:'array' })
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' })
      H.setStatus('โหลดจาก Excel: ' + rows.length + ' แถว')
      return rows
    } catch (e) { H.setStatus('โหลด Excel ไม่สำเร็จ (' + e.message + ')'); return null }
  }

  function normalize(rows){
    return rows.map(r => ({
      [COLS.no]: r[COLS.no] ?? r['No'] ?? r['no'] ?? '',
      [COLS.lr]: r[COLS.lr] ?? r['L&R Number'] ?? r['L&R number'] ?? r['L&R No'] ?? '',
      [COLS.thai]: r[COLS.thai] ?? r['Thai'] ?? r['Thai Name'] ?? '',
      [COLS.common]: r[COLS.common] ?? r['English name'] ?? r['Common Name'] ?? '',
      [COLS.sci]: r[COLS.sci] ?? r['Scientific Name'] ?? '',
      [COLS.family]: r[COLS.family] ?? '',
      [COLS.order]: r[COLS.order] ?? '',
      [COLS.cat]: r[COLS.cat] ?? '',
      [COLS.seas]: r[COLS.seas] ?? '',
      [COLS.gts]: r[COLS.gts] ?? r['Global Threat Status'] ?? '',
      [COLS.nts]: r[COLS.nts] ?? r['National Threat Status'] ?? '',
      [COLS.ntl]: r[COLS.ntl] ?? r['National Threat Level'] ?? '',
    }))
  }

  function renderTable(rows) {
    const tbody = H.byId('tbody')
    let html = ''
    const safe = v => (v==null || v==='') ? '' : String(v)
    for (const r of rows) {
      html += `<tr>
        <td>${safe(r[COLS.no])}</td>
        <td>${safe(r[COLS.lr])}</td>
        <td>${safe(r[COLS.thai])}</td>
        <td>${safe(r[COLS.common])}</td>
        <td><i>${safe(r[COLS.sci])}</i></td>
        <td>${safe(r[COLS.family])}</td>
        <td>${safe(r[COLS.order])}</td>
        <td>${safe(r[COLS.cat])}</td>
        <td>${safe(r[COLS.seas])}</td>
        <td>${safe(r[COLS.gts])}</td>
        <td>${safe(r[COLS.nts])}</td>
        <td>${safe(r[COLS.ntl])}</td>
      </tr>`
    }
    tbody.innerHTML = html
    H.byId('rowCount').textContent = rows.length.toLocaleString()
  }

  function populateSelect(id, values) {
    const el = H.byId(id)
    const keep = el.value
    el.innerHTML = '<option value="">ทั้งหมด</option>' + H.uniqSorted(values).map(v => `<option>${v}</option>`).join('')
    if (keep) el.value = keep
  }
  function refreshSelectOptions() {
    populateSelect('category', ALL_ROWS.map(r => r[COLS.cat]))
    populateSelect('seasonal', ALL_ROWS.map(r => r[COLS.seas]))
    populateSelect('gts', ALL_ROWS.map(r => r[COLS.gts]))
    populateSelect('nts', ALL_ROWS.map(r => r[COLS.nts]))
    populateSelect('ntl', ALL_ROWS.map(r => r[COLS.ntl]))
  }

  function getFilters() {
    return {
      thai: H.byId('thai').value, common: H.byId('common').value, sci: H.byId('scientific').value,
      family: H.byId('family')?.value || '', order: H.byId('order')?.value || '',
      cat: H.byId('category').value, seas: H.byId('seasonal').value, gts: H.byId('gts').value, nts: H.byId('nts').value, ntl: H.byId('ntl').value,
      lrMin: H.parseNum(H.byId('lrMin').value), lrMax: H.parseNum(H.byId('lrMax').value)
    }
  }

  function showActiveFilters(f) {
    const chips = []
    const add = (label, val) => { if (val !== '' && val !== null && val !== undefined) chips.push(`<span class="chip">${label}: ${val}</span>`) }
    add('Thai', f.thai); add('Common', f.common); add('Scientific', f.sci); add('Family', f.family); add('Order', f.order);
    add('Category', f.cat); add('Seasonal', f.seas); add('Global', f.gts); add('National', f.nts); add('BCST Level', f.ntl);
    add('L&R ≥', f.lrMin); add('L&R ≤', f.lrMax);
    H.byId('activeFilters').innerHTML = chips.join('')
  }

  function applyFilters() {
    const f = getFilters()
    showActiveFilters(f)
    const inc = (a,b) => H.includesCI(a,b)
    FILTERED = ALL_ROWS.filter(r => {
      if (f.thai && !inc(r[COLS.thai], f.thai)) return false
      if (f.common && !inc(r[COLS.common], f.common)) return false
      if (f.sci && !inc(r[COLS.sci], f.sci)) return false
      if (f.family && !inc(r[COLS.family], f.family)) return false
      if (f.order && !inc(r[COLS.order], f.order)) return false
      if (f.cat && String(r[COLS.cat]) !== String(f.cat)) return false
      if (f.seas && String(r[COLS.seas]) !== String(f.seas)) return false
      if (f.gts && String(r[COLS.gts]) !== String(f.gts)) return false
      if (f.nts && String(r[COLS.nts]) !== String(f.nts)) return false
      if (f.ntl && String(r[COLS.ntl]) !== String(f.ntl)) return false
      const lrVal = Number(r[COLS.lr])
      if (f.lrMin != null && !(lrVal >= f.lrMin)) return false
      if (f.lrMax != null && !(lrVal <= f.lrMax)) return false
      return true
    })
    renderTable(FILTERED)
    renderList(FILTERED)
  }

  function resetFilters() {
    for (const id of ['thai','common','scientific','family','order','category','seasonal','gts','nts','ntl','lrMin','lrMax']) H.byId(id).value = ''
    applyFilters()
  }

  function exportCSV() {
    const rows = FILTERED.length ? FILTERED : ALL_ROWS
    const headers = [COLS.no, COLS.lr, COLS.thai, COLS.common, COLS.sci, COLS.family, COLS.order, COLS.cat, COLS.seas, COLS.gts, COLS.nts, COLS.ntl]
    const csv = [headers.map(H.escapeCSV).join(',')]
    for (const r of rows) csv.push(headers.map(h => H.escapeCSV(r[h])).join(','))
    const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a'); a.href = url; a.download = 'thai-bird-finder.csv'; a.click(); URL.revokeObjectURL(url)
  }

  function buildListText(rows){ const safe = v => (v==null||v==='')?'':String(v); return rows.map(r => `${safe(r[COLS.thai])} — ${safe(r[COLS.common])} — ${safe(r[COLS.sci])}`).join('\n') }
  function renderList(rows){
    const wrap = H.byId('listWrap'); let html = '<ul class="list">'; const safe = v => (v==null||v==='')?'':String(v)
    for(const r of rows){ html += `<li><span class="nm">${safe(r[COLS.thai])}</span><br><span class="en">${safe(r[COLS.common])}</span> • <span class="sci"><i>${safe(r[COLS.sci])}</i></span></li>` }
    html += '</ul>'; wrap.innerHTML = html
  }

  function setView(v){
    const tbl = document.querySelector('.table-wrap'), list = H.byId('listWrap')
    if (tbl) tbl.style.display = (v==='table') ? 'block' : 'none'
    if (list) list.style.display = (v==='list') ? 'block' : 'none'
    H.byId('btnTable').classList.toggle('active', v==='table')
    H.byId('btnList').classList.toggle('active', v==='list')
    H.byId('btnCopyList').style.display = (v==='list') ? 'inline-block' : 'none'
  }
  function copyList(){
    const rows = FILTERED.length ? FILTERED : ALL_ROWS
    const text = buildListText(rows)
    navigator.clipboard.writeText(text).then(()=>alert('คัดลอกลิสต์แล้ว — ' + rows.length + ' รายการ'))
  }

  async function init(){
    // attach UI events early
    H.byId('btnSearch').addEventListener('click', applyFilters)
    H.byId('btnReset').addEventListener('click', resetFilters)
    H.byId('btnExport').addEventListener('click', exportCSV)
    H.byId('btnTable').addEventListener('click', ()=>setView('table'))
    H.byId('btnList').addEventListener('click', ()=>setView('list'))
    H.byId('btnCopyList').addEventListener('click', copyList)
    for (const id of ['thai','common','scientific','family','order']) H.byId(id).addEventListener('keydown', e => { if (e.key === 'Enter') applyFilters() })
    for (const id of ['category','seasonal','gts','nts','ntl','lrMin','lrMax']) H.byId(id).addEventListener('change', applyFilters)

    H.setStatus('กำลังโหลดข้อมูล…')
    let raw = await tryLoadJSON()
    if (!raw) raw = await loadXLSX('Bird database.xlsx')
    if (!raw) { H.setStatus('โหลดข้อมูลไม่สำเร็จ'); return }
    ALL_ROWS = normalize(raw)
    refreshSelectOptions()
    renderTable(ALL_ROWS)        // แสดงทันที
    setView('table')
  }
  init()
  </script>
</body>
</html>
