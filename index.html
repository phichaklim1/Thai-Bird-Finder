<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thai Bird Finder</title>
  <meta name="description" content="ค้นหาและกรองข้อมูลนกในประเทศไทยจากฐานข้อมูล Excel ของคุณ (BCST/ONEP fields)." />
  <!-- SheetJS for reading Excel in-browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #0b1220;          /* dark blue-gray */
      --panel: #121a2a;       /* panel */
      --muted: #8ea0c2;       /* muted text */
      --text: #e6eefc;        /* main text */
      --accent: #3bb2f6;      /* links / buttons */
      --accent-2: #1dd1a1;    /* secondary */
      --danger: #ff6b6b;
      --chip: #1b2740;
      --border: #24314d;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 15px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    header {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, #0b1220 0%, rgba(11,18,32,.85) 70%, rgba(11,18,32,0) 100%);
      backdrop-filter: saturate(120%) blur(6px);
      padding: 18px 20px 8px 20px; border-bottom: 1px solid var(--border);
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 36px; height: 36px; border-radius: 12px; background: radial-gradient(60% 80% at 30% 30%, #3bb2f6, #1dd1a1 60%, #24314d 100%);
      box-shadow: 0 8px 22px rgba(59,178,246,.25);
    }
    .title { font-weight: 700; font-size: 20px; letter-spacing: .2px; }
    .subtitle { color: var(--muted); font-size: 12px; }

    .container { padding: 16px 20px 24px; display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    @media (max-width: 1000px) {
      .container { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--panel); border: 1px solid var(--border); border-radius: 16px;
      box-shadow: 0 10px 24px rgba(11,18,32,.35);
    }
    .panel h3 { margin: 0 0 12px 0; font-size: 14px; font-weight: 700; letter-spacing: .3px; color: #cfe2ff; }
    .panel .p { color: var(--muted); font-size: 13px; }

    /* Sidebar */
    .sidebar { position: sticky; top: 76px; align-self: start; }
    .filters { padding: 14px; display: grid; gap: 10px; }
    label { font-size: 12px; color: var(--muted); display: block; margin: 8px 0 4px; }
    input[type="text"], input[type="number"], select {
      width: 100%; background: #0e1525; color: var(--text); border: 1px solid var(--border);
      padding: 10px 12px; border-radius: 10px; outline: none; transition: border .15s ease;
    }
    input::placeholder { color: #6f84ad; }
    input:focus, select:focus { border-color: var(--accent); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

    .btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .btn {
      padding: 10px 14px; border: 1px solid var(--border); background: #0f1a2c; color: var(--text);
      border-radius: 10px; cursor: pointer; font-weight: 600; letter-spacing: .2px;
    }
    .btn.primary { background: linear-gradient(90deg, #3bb2f6, #1dd1a1); color: #06233a; border: none; }
    .btn.danger { background: #25131a; border-color: #5c2a38; color: #ffc6cf; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Info / chips */
    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .chip { background: var(--chip); border: 1px solid var(--border); padding: 6px 8px; border-radius: 999px; font-size: 12px; color: #b8caec; }

    /* Main table area */
    .main { padding: 0; display: grid; gap: 12px; }
    .toolbar { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; }
    .count { color: var(--muted); font-size: 13px; }

    .table-wrap { overflow: auto; border-top: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      position: sticky; top: 0; z-index: 5; background: #0e1525; color: #cde2ff; font-size: 12px; text-align: left;
      padding: 10px 10px; border-bottom: 1px solid var(--border);
    }
    tbody td { padding: 9px 10px; border-bottom: 1px solid #19233b; vertical-align: top; }
    tbody tr:nth-child(odd) { background: #0b162a; }

    .foot-note { padding: 12px 14px; color: var(--muted); font-size: 12px; border-top: 1px dashed var(--border); }
    .small { font-size: 12px; color: var(--muted); }
      /* List view & toggle */
    .view-toggle .btn.tab { background:#0f1a2c; border-color: var(--border); }
    .view-toggle .btn.tab.active { background: linear-gradient(90deg, #3bb2f6, #1dd1a1); color:#06233a; border:none; }
    .list-wrap { display:none; }
    .list { list-style:none; margin:0; padding:0; }
    .list li { padding:10px 10px; border-bottom:1px solid #19233b; }
    .list li:nth-child(odd){ background:#0b162a; }
    .list .nm { font-weight:700; }
    .list .en { color: var(--muted); }
    .list .sci { font-style: italic; color: #b8caec; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">Thai Bird Finder</div>
        <div class="subtitle">ค้นหาและกรองข้อมูลนกในประเทศไทย • ใช้ไฟล์ Excel <code>Bird database.xlsx</code> หรือ <code>birds.json</code></div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- LEFT: Filters + Help -->
    <aside class="sidebar">
      <div class="panel">
        <div class="filters">
          <h3>ค้นหา</h3>
          <div class="row">
            <div>
              <label for="thai">Thai name (ค้นหาบางส่วนได้)</label>
              <input id="thai" type="text" placeholder="เช่น กระจอก, นกกินปลี ฯลฯ" />
            </div>
            <div>
              <label for="common">Common name</label>
              <input id="common" type="text" placeholder="e.g. babbler, bulbul" />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="scientific">Scientific name</label>
              <input id="scientific" type="text" placeholder="e.g. Pycnonotus" />
            </div>
            <div>
              <label for="family">Family</label>
              <input id="family" type="text" placeholder="e.g. Anatidae" />
            </div>
          </div>
          <div>
            <label for="order">Order</label>
            <input id="order" type="text" placeholder="e.g. Passeriformes" />
          </div>

          <div class="row">
            <div>
              <label for="category">Category</label>
              <select id="category"><option value="">ทั้งหมด</option></select>
            </div>
            <div>
              <label for="seasonal">Seasonal status</label>
              <select id="seasonal"><option value="">ทั้งหมด</option></select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="gts">Global Threat Status</label>
              <select id="gts"><option value="">ทั้งหมด</option></select>
            </div>
            <div>
              <label for="nts">National Threat Status</label>
              <select id="nts"><option value="">ทั้งหมด</option></select>
            </div>
          </div>

          <div>
            <label for="ntl">National Threat Level (BCST)</label>
            <select id="ntl"><option value="">ทั้งหมด</option></select>
          </div>

          <div class="row">
            <div>
              <label for="lrMin">L&R (min)</label>
              <input id="lrMin" type="number" inputmode="numeric" />
            </div>
            <div>
              <label for="lrMax">L&R (max)</label>
              <input id="lrMax" type="number" inputmode="numeric" />
            </div>
          </div>

          <div class="btns">
            <button class="btn primary" id="btnSearch">ค้นหา</button>
            <button class="btn" id="btnReset">ล้างค่า</button>
            <button class="btn" id="btnExport">ดาวน์โหลดผลลัพธ์ (CSV)</button>
          </div>

          <div class="chips" id="activeFilters"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="filters">
          <h3>คำอธิบายฟิลด์</h3>
          <div class="p">
            <strong>Category:</strong>
            <div class="chips">
              <div class="chip">A: บันทึกในธรรมชาติใน 50 ปีล่าสุด</div>
              <div class="chip">B: ไม่มีบันทึกในธรรมชาติใน 50 ปีล่าสุด</div>
              <div class="chip">C: ชนิดปล่อย/หลุดเลี้ยงและสืบพันธุ์เองได้</div>
              <div class="chip">D: พบในธรรมชาติแต่มีโอกาสเป็นชนิดหลุดเลี้ยง</div>
              <div class="chip">E: บันทึกที่เคยเผยแพร่ไว้อาจคลาดเคลื่อน</div>
              <div class="chip">F: พบลูกผสมโดยไม่มีหลักฐานของชนิดแท้</div>
            </div>
          </div>
          <div class="p" style="margin-top:8px;">
            <strong>Seasonal status:</strong>
            <div class="chips">
              <div class="chip">R: อยู่อาศัยประจำถิ่น</div>
              <div class="chip">N: นกอพยพฤดูไม่ทำรัง</div>
              <div class="chip">B: นกอพยพฤดูทำรัง</div>
              <div class="chip">P: นกอพยพผ่านทางช่วงฤดูใบไม้ผลิ/ใบไม้ร่วง</div>
              <div class="chip">V: หลงนอกถิ่น (มีบันทึก ≤ 3 ครั้ง)</div>
            </div>
          </div>
          <div class="p" style="margin-top:8px;">
            <strong>Threat status:</strong>
            <div class="chips">
              <div class="chip">EX</div>
              <div class="chip">EW</div>
              <div class="chip">CR</div>
              <div class="chip">EN</div>
              <div class="chip">VU</div>
              <div class="chip">NT</div>
              <div class="chip">DD</div>
              <div class="chip">LC/ว่าง</div>
            </div>
          </div>
          <div class="foot-note">* ค่าใน select จะดึงอัตโนมัติจากข้อมูลในไฟล์</div>
        </div>
      </div>
    </aside>

    <!-- RIGHT: Table -->
    <main class="panel main">
      <div class="toolbar">
        <div class="count"><span id="rowCount">–</span> ผลลัพธ์</div>
        <div class="btns view-toggle">
          <button class="btn tab active" id="btnTable">แสดงตาราง</button>
          <button class="btn tab" id="btnList">แสดงลิสต์</button>
          <button class="btn" id="btnCopyList" style="display:none;">คัดลอกลิสต์</button>
        </div>
        <div class="small">ข้อมูลต้นฉบับ: <code>Bird database.xlsx</code> • รองรับไฟล์ <code>birds.json</code> เพื่อโหลดเร็วขึ้น</div>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="min-width:60px;">No.</th>
              <th style="min-width:70px;">L&R</th>
              <th style="min-width:200px;">Thai name</th>
              <th style="min-width:220px;">Common name</th>
              <th style="min-width:220px;">Scientific name</th>
              <th style="min-width:160px;">Family</th>
              <th style="min-width:160px;">Order</th>
              <th style="min-width:90px;">Category</th>
              <th style="min-width:150px;">Seasonal status</th>
              <th style="min-width:200px;">Global Threat Status</th>
              <th style="min-width:230px;">National Threat Status</th>
              <th style="min-width:200px;">National Threat Level (BCST)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="list-wrap" id="listWrap" style="display:none;"></div>
      <div class="foot-note">
        เคล็ดลับ: พิมพ์บางส่วนของชื่อในช่องใดช่องหนึ่งแล้วกด “ค้นหา” หรือกด Enter • ใช้ปุ่ม “ล้างค่า” เพื่อเริ่มใหม่อย่างรวดเร็ว
      </div>
    </main>
  </div>

  <script>
  // ===== Utility helpers =====
  const H = {
    byId: (id) => document.getElementById(id),
    escapeCSV: (v) => {
      const s = v == null ? '' : String(v)
      if (s.includes('"') || s.includes(',') || s.includes('
')) return '"' + s.replaceAll('"', '""') + '"'
      return s
    },
    includesCI: (hay, needle) => String(hay || '').toLowerCase().includes(String(needle || '').trim().toLowerCase()),
    uniqSorted: (arr) => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b))),
    parseNum: (v) => (v === '' || v == null) ? null : Number(v),
    debounce(fn, ms=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); } },
  }

  // ===== App state =====
  const COLS = {
    no: 'No.',
    lr: 'L&R',
    thai: 'Thai name',
    common: 'Common name',
    sci: 'Scientific name',
    family: 'Family',
    order: 'Order',
    cat: 'Category',
    seas: 'Seasonal status',
    gts: 'Global Threat Status (BirdLife 2021)',
    nts: 'National Threat Status (ONEP 2020)',
    ntl: 'National Threat Level (BCST)'
  }

  let ALL_ROWS = []
  let FILTERED = []

  // ===== Loaders =====
  async function tryLoadJSON() {
    try {
      const res = await fetch('birds.json', { cache: 'no-store' })
      if (!res.ok) throw new Error('JSON not found')
      return await res.json()
    } catch (err) { return null }
  }

  async function loadXLSX(path='Bird database.xlsx') {
    const res = await fetch(path)
    if (!res.ok) throw new Error('ไม่พบไฟล์ Excel: ' + path)
    const ab = await res.arrayBuffer()
    const wb = XLSX.read(ab, { type: 'array' })
    const first = wb.SheetNames[0]
    const sheet = wb.Sheets[first]
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' })
    return rows
  }

  function normalize(rows) {
    return rows.map(r => ({
      [COLS.no]: r[COLS.no] ?? r['No'] ?? r['no'] ?? '',
      [COLS.lr]: r[COLS.lr] ?? r['L&R Number'] ?? r['L&R number'] ?? r['L&R No'] ?? '',
      [COLS.thai]: r[COLS.thai] ?? r['Thai'] ?? r['Thai Name'] ?? '',
      [COLS.common]: r[COLS.common] ?? r['English name'] ?? r['Common Name'] ?? '',
      [COLS.sci]: r[COLS.sci] ?? r['Scientific Name'] ?? '',
      [COLS.family]: r[COLS.family] ?? '',
      [COLS.order]: r[COLS.order] ?? '',
      [COLS.cat]: r[COLS.cat] ?? '',
      [COLS.seas]: r[COLS.seas] ?? '',
      [COLS.gts]: r[COLS.gts] ?? r['Global Threat Status'] ?? '',
      [COLS.nts]: r[COLS.nts] ?? r['National Threat Status'] ?? '',
      [COLS.ntl]: r[COLS.ntl] ?? r['National Threat Level'] ?? '',
    }))
  }

  // ===== Rendering =====
  function renderTable(rows) {
    const tbody = H.byId('tbody')
    let html = ''
    const safe = v => (v==null || v==='') ? '' : String(v)
    for (const r of rows) {
      html += `<tr>
        <td>${safe(r[COLS.no])}</td>
        <td>${safe(r[COLS.lr])}</td>
        <td>${safe(r[COLS.thai])}</td>
        <td>${safe(r[COLS.common])}</td>
        <td><i>${safe(r[COLS.sci])}</i></td>
        <td>${safe(r[COLS.family])}</td>
        <td>${safe(r[COLS.order])}</td>
        <td>${safe(r[COLS.cat])}</td>
        <td>${safe(r[COLS.seas])}</td>
        <td>${safe(r[COLS.gts])}</td>
        <td>${safe(r[COLS.nts])}</td>
        <td>${safe(r[COLS.ntl])}</td>
      </tr>`
    }
    tbody.innerHTML = html
    H.byId('rowCount').textContent = rows.length.toLocaleString()
  }

  function populateSelect(id, values, opts={}) {
    const el = H.byId(id)
    const keep = el.value
    el.innerHTML = '<option value="">ทั้งหมด</option>' + H.uniqSorted(values).map(v => `<option>${v}</option>`).join('')
    if (opts.value) el.value = opts.value
    else if (keep) el.value = keep
  }

  function refreshSelectOptions() {
    // Options from ALL_ROWS to ensure full value set regardless of current filter
    populateSelect('category', ALL_ROWS.map(r => r[COLS.cat]))
    populateSelect('seasonal', ALL_ROWS.map(r => r[COLS.seas]))
    populateSelect('gts', ALL_ROWS.map(r => r[COLS.gts]))
    populateSelect('nts', ALL_ROWS.map(r => r[COLS.nts]))
    populateSelect('ntl', ALL_ROWS.map(r => r[COLS.ntl]))
  }

  // ===== Filtering =====
  function getFilters() {
    return {
      thai: H.byId('thai').value,
      common: H.byId('common').value,
      sci: H.byId('scientific').value,
      family: H.byId('family').value,
      order: H.byId('order').value,
      cat: H.byId('category').value,
      seas: H.byId('seasonal').value,
      gts: H.byId('gts').value,
      nts: H.byId('nts').value,
      ntl: H.byId('ntl').value,
      lrMin: H.parseNum(H.byId('lrMin').value),
      lrMax: H.parseNum(H.byId('lrMax').value)
    }
  }

  function showActiveFilters(f) {
    const chips = []
    const add = (label, val) => { if (val !== '' && val !== null && val !== undefined) chips.push(`<span class="chip">${label}: ${val}</span>`) }
    add('Thai', f.thai)
    add('Common', f.common)
    add('Scientific', f.sci)
    add('Family', f.family)
    add('Order', f.order)
    add('Category', f.cat)
    add('Seasonal', f.seas)
    add('Global', f.gts)
    add('National', f.nts)
    add('BCST Level', f.ntl)
    add('L&R ≥', f.lrMin)
    add('L&R ≤', f.lrMax)
    H.byId('activeFilters').innerHTML = chips.join('')
  }

  function applyFilters() {
    const f = getFilters()
    showActiveFilters(f)
    FILTERED = ALL_ROWS.filter(r => {
      if (f.thai && !H.includesCI(r[COLS.thai], f.thai)) return false
      if (f.common && !H.includesCI(r[COLS.common], f.common)) return false
      if (f.sci && !H.includesCI(r[COLS.sci], f.sci)) return false
      if (f.family && !H.includesCI(r[COLS.family], f.family)) return false
      if (f.order && !H.includesCI(r[COLS.order], f.order)) return false

      if (f.cat && String(r[COLS.cat]) !== String(f.cat)) return false
      if (f.seas && String(r[COLS.seas]) !== String(f.seas)) return false
      if (f.gts && String(r[COLS.gts]) !== String(f.gts)) return false
      if (f.nts && String(r[COLS.nts]) !== String(f.nts)) return false
      if (f.ntl && String(r[COLS.ntl]) !== String(f.ntl)) return false

      const lrVal = Number(r[COLS.lr])
      if (f.lrMin != null && !(lrVal >= f.lrMin)) return false
      if (f.lrMax != null && !(lrVal <= f.lrMax)) return false
      return true
    })
    renderTable(FILTERED)
    renderList(FILTERED)
  }

  function resetFilters() {
    for (const id of ['thai','common','scientific','family','order','category','seasonal','gts','nts','ntl','lrMin','lrMax']) {
      const el = H.byId(id); el.value = ''
    }
    applyFilters()
  }

  function exportCSV() {
    const rows = FILTERED.length ? FILTERED : ALL_ROWS
    const headers = [COLS.no, COLS.lr, COLS.thai, COLS.common, COLS.sci, COLS.family, COLS.order, COLS.cat, COLS.seas, COLS.gts, COLS.nts, COLS.ntl]
    const csv = [headers.map(H.escapeCSV).join(',')]
    for (const r of rows) csv.push(headers.map(h => H.escapeCSV(r[h])).join(','))
    const blob = new Blob([csv.join('
')], { type: 'text/csv;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a'); a.href = url; a.download = 'thai-bird-finder.csv'; a.click(); URL.revokeObjectURL(url)
  }

  // ===== Additional Views (List) =====
  function buildListText(rows){
    const safe = v => (v==null||v==='')?'':String(v)
    return rows.map(r => `${safe(r[COLS.thai])} — ${safe(r[COLS.common])} — ${safe(r[COLS.sci])}`).join('
')
  }

  function renderList(rows){
    const wrap = H.byId('listWrap')
    let html = '<ul class="list">'
    const safe = v => (v==null||v==='')?'':String(v)
    for(const r of rows){
      html += `<li><span class="nm">${safe(r[COLS.thai])}</span><br><span class="en">${safe(r[COLS.common])}</span> • <span class="sci"><i>${safe(r[COLS.sci])}</i></span></li>`
    }
    html += '</ul>'
    wrap.innerHTML = html
  }

  let VIEW = 'table'
  function setView(v){
    VIEW = v
    const tbl = document.querySelector('.table-wrap')
    const list = H.byId('listWrap')
    if (tbl) tbl.style.display = (v==='table') ? 'block' : 'none'
    if (list) list.style.display = (v==='list') ? 'block' : 'none'
    const bt = H.byId('btnTable'); const bl = H.byId('btnList'); const bc = H.byId('btnCopyList')
    if (bt) bt.classList.toggle('active', v==='table')
    if (bl) bl.classList.toggle('active', v==='list')
    if (bc) bc.style.display = (v==='list') ? 'inline-block' : 'none'
  }

  function copyList(){
    const rows = FILTERED.length ? FILTERED : ALL_ROWS
    const text = buildListText(rows)
    navigator.clipboard.writeText(text).then(()=>{
      alert('คัดลอกลิสต์แล้ว — ' + rows.length + ' รายการ')
    }).catch(()=>{
      // fallback
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      alert('คัดลอกลิสต์แล้ว — ' + rows.length + ' รายการ')
    })
  }

  // ===== Init =====
  async function init() {
    try {
      const json = await tryLoadJSON()
      const raw = json || await loadXLSX('Bird database.xlsx')
      ALL_ROWS = normalize(raw)
      refreshSelectOptions()
      applyFilters()
      setView('table')
    } catch (err) {
      alert('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message + '

โปรดวางไฟล์ "Bird database.xlsx" หรือ "birds.json" ไว้ในโฟลเดอร์เดียวกับไฟล์นี้')
      console.error(err)
    }

    // Wire up events
    H.byId('btnSearch').addEventListener('click', applyFilters)
    H.byId('btnReset').addEventListener('click', resetFilters)
    H.byId('btnExport').addEventListener('click', exportCSV)

    // View toggles
    H.byId('btnTable').addEventListener('click', ()=>setView('table'))
    H.byId('btnList').addEventListener('click', ()=>setView('list'))
    H.byId('btnCopyList').addEventListener('click', copyList)

    // Enter key triggers search
    for (const id of ['thai','common','scientific','family','order']) {
      H.byId(id).addEventListener('keydown', e => { if (e.key === 'Enter') applyFilters() })
    }

    // Live filtering for selects and number fields
    for (const id of ['category','seasonal','gts','nts','ntl','lrMin','lrMax']) {
      H.byId(id).addEventListener('change', applyFilters)
    }
  }

  init()
  </script>
</body>
</html>
